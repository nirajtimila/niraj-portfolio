<script>
  window.onload = function () {
    document.getElementById('logs').innerHTML = '';
    document.getElementById('message').innerText = '';
    document.getElementById('progressBar').style.width = "0%";
    document.getElementById('progressContainer').style.display = 'none';
  };

  function clearLogsAfterDelay(delay) {
    setTimeout(() => {
      document.getElementById('logs').innerHTML = '';
      document.getElementById('message').innerText = '';
    }, delay);
  }

  function submitLink() {
    const link = document.getElementById('link').value;
    if (!link) {
      document.getElementById('message').innerText = "Please enter a TikTok link.";
      return;
    }

    document.getElementById('message').innerText = '';
    document.getElementById('logs').innerHTML = '';
    document.getElementById('progressContainer').style.display = 'block';

    let progress = 0;
    const progressBar = document.getElementById('progressBar');

    const interval = setInterval(() => {
      if (progress < 100) {
        progress += 2;
        progressBar.style.width = progress + "%";
      }
    }, 300);

    fetch('https://tiktokviewgetter-1472a9f9667f.herokuapp.com/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ link })
    })
    .then(res => res.json())
    .then(data => {
      clearInterval(interval);
      progressBar.style.width = "100%";
      document.getElementById('message').innerText = data.message;
      clearLogsAfterDelay(30000);

      setTimeout(() => {
        document.getElementById('progressContainer').style.display = 'none';
        progressBar.style.width = "0%";
      }, 500);
    })
    .catch(err => {
      clearInterval(interval);
      document.getElementById('message').innerText = "‚ùå Something went wrong.";
      document.getElementById('progressContainer').style.display = 'none';
      progressBar.style.width = "0%";
      clearLogsAfterDelay(30000);
    });
  }

  const eventSource = new EventSource('https://tiktokviewgetter-1472a9f9667f.herokuapp.com/progress');
  eventSource.onmessage = function(event) {
    const log = event.data;
    const logsDiv = document.getElementById('logs');
    logsDiv.innerHTML += `<p>${log}</p>`;
    logsDiv.scrollTop = logsDiv.scrollHeight;
  };
</script>
